// EDUKKARE - Schema do Banco de Dados
// Sistema Inteligente para Educação Infantil

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  PROFESSOR
  COORDENADOR
  GESTOR
  ADMIN
}

enum NivelAcesso {
  ESTRATEGICO
  OPERACIONAL
  PEDAGOGICO
  NUCLEO_FAMILIAR
  PROFISSIONAIS_EXTERNOS
}

enum StudentShift {
  MANHA
  TARDE
  INTEGRAL
}

enum EvidenceType {
  FOTO
  AUDIO
  VIDEO
  NOTA
}

enum EvaluationLevel {
  NAO_REALIZOU     // 0-33%
  PARCIALMENTE     // 34-66%
  REALIZOU         // 67-100%
}

// Modelos

model Avatar {
  id            Int       @id @default(autoincrement())
  avatar        String    // Nome do arquivo do avatar (ex: "alice.png")
  createdAt     DateTime  @default(now())

  students      Student[]
  
  @@map("avatars")
}

model User {
  id            Int         @id @default(autoincrement())
  email         String      @unique
  password      String
  name          String
  role          UserRole    @default(PROFESSOR)
  nivelAcesso   NivelAcesso @default(PEDAGOGICO)
  active        Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  evaluations   Evaluation[]
  evidences     Evidence[]
  
  @@map("users")
}

model Teacher {
  id              Int       @id @default(autoincrement())
  name            String
  email           String    @unique
  phone           String?
  specialization  String?
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  classes         Class[]   // Relação com turmas
  
  @@map("teachers")
}

model School {
  id            Int       @id @default(autoincrement())
  name          String
  address       String?
  phone         String?
  email         String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("schools")
}

model Student {
  id            Int           @id @default(autoincrement())
  name          String
  birthDate     DateTime
  responsavel   String
  telefone      String?
  email         String?
  shift         StudentShift
  active        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  classId       Int
  class         Class         @relation(fields: [classId], references: [id])
  
  avatarId      Int?
  avatar        Avatar?       @relation(fields: [avatarId], references: [id])
  
  evaluations   Evaluation[]
  evidences     Evidence[]
  aiInsights    AIInsight[]
  
  @@map("students")
}

model Class {
  id            Int       @id @default(autoincrement())
  name          String
  age_group     String    // "Berçário I", "Infantil II", etc
  shift         StudentShift
  year          Int
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  teacherId     Int       // ID do professor da tabela teachers
  teacher       Teacher   @relation(fields: [teacherId], references: [id])
  
  students      Student[]
  activities    Activity[]
  
  @@map("classes")
}

model BNCCCode {
  id            Int       @id @default(autoincrement())
  code          String    @unique // "EI02TS02"
  name          String    // "Traços, sons, cores e formas"
  description   String
  field         String    // "Traços, sons, cores e formas"
  age_group     String    // "Crianças pequenas (2-3 anos)"
  createdAt     DateTime  @default(now())

  activities    Activity[]
  evaluations   Evaluation[]
  
  @@map("bncc_codes")
}

model Activity {
  id                Int       @id @default(autoincrement())
  activityCode      String?   @unique // Ex: "E101CG01" - Nullable por enquanto para migração
  title             String
  description       String
  content           String?   @db.Text // Conteúdo completo em markdown/texto
  documentationPath String?   // Caminho do arquivo de documentação anexado
  duration          Int       // em minutos
  materials         String?   // JSON com lista de materiais
  objectives        String    // JSON com objetivos
  active            Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  bnccCodeId    Int
  bnccCode      BNCCCode  @relation(fields: [bnccCodeId], references: [id])
  
  classId       Int?
  class         Class?    @relation(fields: [classId], references: [id])
  
  evaluations   Evaluation[]
  rubrics       Rubric[]
  
  @@map("activities")
}

model Evaluation {
  id            Int             @id @default(autoincrement())
  level         EvaluationLevel
  percentage    Int             // 0-100
  observations  String?
  date          DateTime        @default(now())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  studentId     Int
  student       Student         @relation(fields: [studentId], references: [id])
  
  activityId    Int
  activity      Activity        @relation(fields: [activityId], references: [id])
  
  bnccCodeId    Int
  bnccCode      BNCCCode        @relation(fields: [bnccCodeId], references: [id])
  
  teacherId     Int
  teacher       User            @relation(fields: [teacherId], references: [id])
  
  evidences     Evidence[]
  
  @@map("evaluations")
}

model Evidence {
  id            Int           @id @default(autoincrement())
  type          EvidenceType
  filename      String
  filepath      String
  filesize      Int?
  mimeType      String?
  transcription String?       // Para áudios
  aiAnalysis    String?       // JSON com análise da IA
  createdAt     DateTime      @default(now())

  studentId     Int
  student       Student       @relation(fields: [studentId], references: [id])
  
  teacherId     Int
  teacher       User          @relation(fields: [teacherId], references: [id])
  
  evaluationId  Int?
  evaluation    Evaluation?   @relation(fields: [evaluationId], references: [id])
  
  @@map("evidences")
}

model AIInsight {
  id            Int       @id @default(autoincrement())
  type          String    // "ATENCAO", "SUGESTAO", "MENSAGEM_FAMILIA"
  title         String
  content       String
  priority      Int       @default(1)
  accepted      Boolean   @default(false)
  viewed        Boolean   @default(false)
  createdAt     DateTime  @default(now())

  studentId     Int?
  student       Student?  @relation(fields: [studentId], references: [id])
  
  @@map("ai_insights")
}

model DashboardMetric {
  id            Int       @id @default(autoincrement())
  metric        String    // "total_students", "bncc_coverage", etc
  value         String
  trend         String?
  period        String    // "daily", "weekly", "monthly"
  date          DateTime  @default(now())
  metadata      String?   // JSON adicional

  @@map("dashboard_metrics")
}

model Rubric {
  id            Int       @id @default(autoincrement())
  rubricCode    String    @unique // Ex: "RUB-E101CG01-001"
  name          String    // Nome da rubrica
  description   String    @db.Text
  activityCode  String    // Código da atividade (ex: "E101CG01")
  
  // Níveis de avaliação em JSON:
  // { 
  //   "excelente": { "title": "Excelente", "description": "...", "stars": 3 },
  //   "satisfatorio": { "title": "Satisfatório", "description": "...", "stars": 2 },
  //   "desenvolvimento": { "title": "Em Desenvolvimento", "description": "...", "stars": 1 },
  //   "iniciante": { "title": "Iniciante", "description": "...", "stars": 0 }
  // }
  levels        String    @db.Text // JSON com os níveis
  
  criteria      String?   @db.Text // Critérios específicos de avaliação
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  activityId    Int
  activity      Activity  @relation(fields: [activityId], references: [id])
  
  @@map("rubrics")
}

model MenuPermission {
  id            Int         @id @default(autoincrement())
  menuItem      String      // Identificador único do item (ex: 'home', 'gestor', 'gestor.dashboard')
  menuLabel     String      // Nome exibido (ex: 'Início', 'Gestor', 'Dashboard')
  parentItem    String?     // Item pai (null para itens raiz)
  nivelAcesso   NivelAcesso // Nível de acesso necessário
  order         Int         // Ordem de exibição
  icon          String?     // Ícone do item
  screen        String?     // Tela associada (ex: 'home', 'dashboard')
  active        Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([menuItem, nivelAcesso])
  @@map("menu_permissions")
}
